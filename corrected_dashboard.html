<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Plex Preroll Manager</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e2e8f0;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .header h1 {
            color: #f1f5f9;
            font-size: 3em;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        .header p {
            color: #94a3b8;
            font-size: 1.1em;
            font-weight: 400;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        .status-card h3 {
            color: #f1f5f9;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 10px currentColor;
        }
        .status-connected { background-color: #10b981; color: #10b981; }
        .status-disconnected { background-color: #ef4444; color: #ef4444; }
        .categories-section, .upload-section, .scheduling-section {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .categories-section h2, .upload-section h2, .scheduling-section h2 {
            color: #f1f5f9;
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            letter-spacing: -0.01em;
        }
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .category-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        .category-card:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }
        .category-card.active {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }
        .category-card h4 {
            color: #f1f5f9;
            margin-bottom: 12px;
            font-size: 1.2em;
            font-weight: 600;
        }
        .category-stats {
            color: #94a3b8;
            font-size: 0.9em;
            font-weight: 500;
        }
        .btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            letter-spacing: 0.025em;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        .btn-secondary {
            background: rgba(71, 85, 105, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-secondary:hover {
            background: rgba(100, 116, 139, 0.8);
            border-color: rgba(255, 255, 255, 0.2);
        }
        .upload-form {
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #f1f5f9;
            font-weight: 600;
            font-size: 0.95em;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(30, 41, 59, 0.6);
            color: #f1f5f9;
            backdrop-filter: blur(10px);
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-group input::placeholder {
            color: #64748b;
        }
        .prerolls-list {
            margin-top: 20px;
        }
        .preroll-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(10px);
        }
        .preroll-thumbnail {
            flex-shrink: 0;
        }
        .preroll-thumbnail img {
            width: 120px;
            height: 68px;
            object-fit: cover;
            border-radius: 6px;
            transition: transform 0.2s ease;
        }
        .preroll-thumbnail img:hover {
            transform: scale(1.05);
        }
        .no-thumbnail {
            width: 120px;
            height: 68px;
            background: rgba(59, 130, 246, 0.1);
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 12px;
            text-align: center;
        }
        .preroll-info {
            flex: 1;
        }
        .preroll-meta {
            margin-top: 8px;
        }
        .preroll-actions {
            flex-shrink: 0;
        }
        .preroll-info h5 {
            color: #f1f5f9;
            margin-bottom: 6px;
            font-weight: 600;
        }
        .preroll-info small {
            color: #94a3b8;
            font-size: 0.85em;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
            font-style: italic;
        }
        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            padding: 16px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        .success {
            background: rgba(16, 185, 129, 0.1);
            color: #86efac;
            padding: 16px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        .schedules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .schedule-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        .schedule-item h4 {
            color: #f1f5f9;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: 600;
        }
        .schedule-meta {
            color: #94a3b8;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        .schedule-actions {
            display: flex;
            gap: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: rgba(15, 23, 42, 0.95);
            margin: 5% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }
        .modal-header h2 {
            color: #f1f5f9;
            margin: 0;
        }
        .close {
            font-size: 28px;
            font-weight: bold;
            color: #94a3b8;
            cursor: pointer;
        }
        .close:hover {
            color: #f1f5f9;
        }
        /* Upload Mode Toggle */
        .upload-mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .upload-mode-toggle .btn {
            flex: 1;
        }

        .upload-mode-toggle .btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        /* Bulk Upload Styles */
        .bulk-upload-form {
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.05);
        }

        .bulk-file-list {
            margin-top: 20px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bulk-file-list h4 {
            color: #f1f5f9;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 5px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 6px;
            font-size: 0.9em;
        }

        .file-name {
            color: #f1f5f9;
            flex: 1;
        }

        .file-size {
            color: #94a3b8;
            font-size: 0.8em;
        }

        /* Upload Progress Styles */
        .upload-progress {
            margin-top: 20px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .progress-header {
            margin-bottom: 15px;
        }

        .progress-header h4 {
            color: #f1f5f9;
            margin-bottom: 10px;
        }

        .overall-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: #f1f5f9;
            font-weight: 600;
            min-width: 45px;
            text-align: right;
        }

        .individual-progress {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-progress-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 6px;
        }

        .file-progress-name {
            flex: 1;
            color: #f1f5f9;
            font-size: 0.9em;
        }

        .file-progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 3px;
            overflow: hidden;
        }

        .file-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .file-progress-status {
            color: #94a3b8;
            font-size: 0.8em;
            min-width: 60px;
            text-align: right;
        }

        .upload-complete {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .upload-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header { padding: 30px 20px; }
            .header h1 { font-size: 2.2em; }
            .status-grid { grid-template-columns: 1fr; }
            .categories-grid { grid-template-columns: 1fr; }
            .categories-section, .upload-section, .scheduling-section { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <h1>Plex Preroll Manager</h1>
            <p>Manage your Plex cinema prerolls with ease</p>
        </div>

        <div class='status-grid'>
            <div class='status-card'>
                <h3><span class='status-indicator' id='plexStatus'></span>Plex Server</h3>
                <div id='plexInfo'>Loading...</div>
            </div>
            <div class='status-card'>
                <h3>Statistics</h3>
                <div id='statsInfo'>Loading...</div>
            </div>
            <div class='status-card'>
                <h3>Active Category</h3>
                <div id='activeCategory'>Loading...</div>
            </div>
        </div>

        <div class='categories-section'>
            <h2>Categories</h2>
            <div class='categories-grid' id='categoriesGrid'>
                <div class='loading'>Loading categories...</div>
            </div>
        </div>

        <div class='prerolls-list' id='prerollsSection' style='display: none;'>
            <h2>Prerolls in <span id='currentCategory'></span></h2>
            <div id='prerollsGrid'>
                <div class='loading'>Loading prerolls...</div>
            </div>
        </div>

        <div class='upload-section'>
            <h2>Upload New Preroll</h2>

            <!-- Upload Mode Toggle -->
            <div class='upload-mode-toggle'>
                <button type='button' class='btn btn-secondary' id='singleUploadBtn' onclick='setUploadMode("single")'>Single Upload</button>
                <button type='button' class='btn' id='bulkUploadBtn' onclick='setUploadMode("bulk")'>Bulk Upload</button>
            </div>

            <!-- Single Upload Form -->
            <form class='upload-form' id='singleUploadForm' enctype='multipart/form-data'>
                <div class='form-group'>
                    <label for='videoFile'>Video File:</label>
                    <input type='file' id='videoFile' name='file' accept='video/*' required>
                </div>
                <div class='form-group'>
                    <label for='category'>Category:</label>
                    <input type='text' id='category' name='category' list='categoryList' placeholder='Select or type new category' required>
                    <datalist id='categoryList'>
                        <!-- Categories will be populated dynamically -->
                    </datalist>
                </div>
                <div class='form-group'>
                    <label for='videoName'>Video Name:</label>
                    <input type='text' id='videoName' name='name' placeholder='Enter video name' required>
                </div>
                <button type='submit' class='btn'>Upload Video</button>
            </form>

            <!-- Bulk Upload Form -->
            <form class='upload-form bulk-upload-form' id='bulkUploadForm' enctype='multipart/form-data' style='display: none;'>
                <div class='form-group'>
                    <label for='bulkVideoFiles'>Video Files (Multiple):</label>
                    <input type='file' id='bulkVideoFiles' name='files' accept='video/*' multiple required>
                    <small style='color: #94a3b8; margin-top: 5px; display: block;'>Select multiple video files to upload to the same category</small>
                </div>
                <div class='form-group'>
                    <label for='bulkCategory'>Category (All files):</label>
                    <input type='text' id='bulkCategory' name='category' list='bulkCategoryList' placeholder='Select or type new category' required>
                    <datalist id='bulkCategoryList'>
                        <!-- Categories will be populated dynamically -->
                    </datalist>
                </div>
                <div class='bulk-file-list' id='bulkFileList' style='display: none;'>
                    <h4>Files to Upload:</h4>
                    <div id='fileListContainer'></div>
                </div>
                <button type='submit' class='btn'>Upload All Files</button>
            </form>

            <!-- Upload Progress -->
            <div class='upload-progress' id='uploadProgress' style='display: none;'>
                <div class='progress-header'>
                    <h4 id='progressTitle'>Uploading...</h4>
                    <div class='overall-progress'>
                        <div class='progress-bar'>
                            <div class='progress-fill' id='overallProgressFill'></div>
                        </div>
                        <span class='progress-text' id='overallProgressText'>0%</span>
                    </div>
                </div>
                <div class='individual-progress' id='individualProgress'></div>
            </div>
        </div>

        <!-- Scheduling Section -->
        <div class='scheduling-section'>
            <h2>⏰ Scheduled Preroll Activations</h2>
            <div style='margin-bottom: 20px;'>
                <button class='btn' onclick='showScheduleModal()'>➕ Create Schedule</button>
            </div>
            <div id='schedulesList' class='schedules-grid'>
                <div class='loading'>Loading schedules...</div>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id='scheduleModal' class='modal'>
        <div class='modal-content'>
            <div class='modal-header'>
                <h2>Create New Schedule</h2>
                <span class='close' onclick='closeScheduleModal()'>×</span>
            </div>
            <form id='scheduleForm'>
                <div class='form-group'>
                    <label for='scheduleCategory'>Category:</label>
                    <select id='scheduleCategory' required>
                        <option value=''>Select Category</option>
                    </select>
                </div>
                <div class='form-group'>
                    <label for='scheduleType'>Schedule Type:</label>
                    <select id='scheduleType' onchange='toggleDateFields()' required>
                        <option value='OneTime'>One Time</option>
                        <option value='Daily'>Daily</option>
                        <option value='Weekly'>Weekly</option>
                        <option value='Monthly'>Monthly</option>
                        <option value='Yearly'>Yearly</option>
                    </select>
                </div>
                <div class='form-group'>
                    <label for='startDate'>Start Date & Time:</label>
                    <input type='datetime-local' id='startDate' required>
                </div>
                <div class='form-group' id='endDateGroup' style='display: none;'>
                    <label for='endDate'>End Date & Time (optional):</label>
                    <input type='datetime-local' id='endDate'>
                </div>
                <div class='form-group'>
                    <label for='scheduleDescription'>Description:</label>
                    <input type='text' id='scheduleDescription' placeholder='e.g., Christmas prerolls' required>
                </div>
                <div style='display: flex; gap: 10px;'>
                    <button type='submit' class='btn'>✅ Create Schedule</button>
                    <button type='button' class='btn btn-secondary' onclick='closeScheduleModal()'>❌ Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentCategory = null;
        let schedules = [];

        // Load initial data
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                // Update Plex status
                const plexIndicator = document.getElementById('plexStatus');
                const plexInfo = document.getElementById('plexInfo');
                if (data.PlexConnected) {
                    plexIndicator.className = 'status-indicator status-connected';
                    plexInfo.innerHTML = `<strong>${data.PlexServerName}</strong><br>Connected`;
                } else {
                    plexIndicator.className = 'status-indicator status-disconnected';
                    plexInfo.innerHTML = 'Disconnected';
                }

                // Update stats
                document.getElementById('statsInfo').innerHTML = `Total Prerolls: <strong>${data.TotalPrerolls}</strong>`;
                document.getElementById('activeCategory').innerHTML = `<strong>${data.ActiveCategory}</strong>`;

            } catch (error) {
                console.error('Error loading status:', error);
                showError('Failed to load status information');
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const categories = await response.json();

                const grid = document.getElementById('categoriesGrid');
                if (categories.length === 0) {
                    grid.innerHTML = '<p>No categories found. Upload some videos to get started!</p>';
                    return;
                }

                grid.innerHTML = categories.map(category => `
                    <div class='category-card ${category.IsActive ? 'active' : ''}' onclick='selectCategory("${category.Name}")'>
                        <h4>${category.Name}</h4>
                        <div class='category-stats'>
                            ${category.PrerollCount} video${category.PrerollCount !== 1 ? 's' : ''}<br>
                            ${category.IsActive ? '✅ Active' : 'Inactive'}
                        </div>
                        ${category.IsActive ? '' : `<button class='btn btn-secondary' onclick='event.stopPropagation(); activateCategory("${category.Name}")'>Activate</button>`}
                    </div>
                `).join('');

                updateUploadCategoryDropdown();

            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById('categoriesGrid').innerHTML = '<div class="error">Failed to load categories</div>';
            }
        }

        async function selectCategory(categoryName) {
            currentCategory = categoryName;
            document.getElementById('currentCategory').textContent = categoryName;
            document.getElementById('prerollsSection').style.display = 'block';

            try {
                const response = await fetch(`/api/prerolls/${categoryName}`);
                const prerolls = await response.json();

                const grid = document.getElementById('prerollsGrid');
                if (prerolls.length === 0) {
                    grid.innerHTML = '<p>No prerolls in this category yet.</p>';
                    return;
                }

                grid.innerHTML = prerolls.map(preroll => `
                    <div class='preroll-item'>
                        <div class='preroll-thumbnail'>
                            ${preroll.ThumbnailPath ?
                                `<img src='${preroll.ThumbnailPath}' alt='${preroll.Name}' onclick='previewVideo("${preroll.FilePath}")' style='cursor: pointer;'>` :
                                `<div class='no-thumbnail'>🎬<br>No Preview</div>`
                            }
                        </div>
                        <div class='preroll-info'>
                            <h5>${preroll.Name}</h5>
                            <div class='preroll-meta'>
                                ${preroll.HasMetadata ? `
                                    <small>
                                        ${preroll.Duration ? `Duration: ${formatDuration(preroll.Duration)} | ` : ''}
                                        ${preroll.Resolution ? `Resolution: ${preroll.Resolution} | ` : ''}
                                        Size: ${(preroll.FileSizeBytes / 1024 / 1024).toFixed(1)} MB<br>
                                        ${preroll.VideoCodec ? `Video: ${preroll.VideoCodec}` : ''}
                                        ${preroll.AudioCodec ? ` | Audio: ${preroll.AudioCodec}` : ''}
                                    </small>
                                ` : `
                                    <small>Size: ${(preroll.FileSizeBytes / 1024 / 1024).toFixed(1)} MB | Added: ${new Date(preroll.CreatedDate).toLocaleDateString()}</small>
                                `}
                            </div>
                        </div>
                        <div class='preroll-actions'>
                            <button class='btn btn-secondary' onclick='deletePreroll("${preroll.Id}")'>Delete</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading prerolls:', error);
                document.getElementById('prerollsGrid').innerHTML = '<div class="error">Failed to load prerolls</div>';
            }
        }

        async function activateCategory(categoryName) {
            try {
                const response = await fetch(`/api/categories/${categoryName}/activate`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showSuccess(`Category '${categoryName}' activated successfully!`);
                    loadStatus();
                    loadCategories();
                } else {
                    showError('Failed to activate category');
                }
            } catch (error) {
                console.error('Error activating category:', error);
                showError('Failed to activate category');
            }
        }

        async function deletePreroll(prerollId) {
            if (!confirm('Are you sure you want to delete this preroll?')) return;

            try {
                const response = await fetch(`/api/prerolls/${prerollId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showSuccess('Preroll deleted successfully!');
                    if (currentCategory) {
                        selectCategory(currentCategory);
                    }
                    loadCategories();
                } else {
                    showError('Failed to delete preroll');
                }
            } catch (error) {
                console.error('Error deleting preroll:', error);
                showError('Failed to delete preroll');
            }
        }

        // Global variables for upload tracking
        let currentUploadMode = 'single';
        let uploadController = null;

        // Upload mode switching
        function setUploadMode(mode) {
            currentUploadMode = mode;

            const singleBtn = document.getElementById('singleUploadBtn');
            const bulkBtn = document.getElementById('bulkUploadBtn');
            const singleForm = document.getElementById('singleUploadForm');
            const bulkForm = document.getElementById('bulkUploadForm');

            if (mode === 'single') {
                singleBtn.classList.add('active');
                bulkBtn.classList.remove('active');
                singleForm.style.display = 'block';
                bulkForm.style.display = 'none';
            } else {
                bulkBtn.classList.add('active');
                singleBtn.classList.remove('active');
                bulkForm.style.display = 'block';
                singleForm.style.display = 'none';
            }
        }

        // Bulk file selection handler
        document.getElementById('bulkVideoFiles').addEventListener('change', (e) => {
            const files = e.target.files;
            const fileListContainer = document.getElementById('fileListContainer');
            const bulkFileList = document.getElementById('bulkFileList');

            if (files.length > 0) {
                bulkFileList.style.display = 'block';
                fileListContainer.innerHTML = '';

                Array.from(files).forEach((file, index) => {
                    const fileSizeMB = (file.size / 1024 / 1024).toFixed(1);
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span class='file-name'>${file.name}</span>
                        <span class='file-size'>${fileSizeMB} MB</span>
                    `;
                    fileListContainer.appendChild(fileItem);
                });
            } else {
                bulkFileList.style.display = 'none';
            }
        });

        // Single upload form handler
        document.getElementById('singleUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await uploadFiles('single');
        });

        // Bulk upload form handler
        document.getElementById('bulkUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await uploadFiles('bulk');
        });

        // Unified upload function
        async function uploadFiles(mode) {
            const formData = new FormData();
            let category = '';
            let files = [];

            if (mode === 'single') {
                const fileInput = document.getElementById('videoFile');
                const categoryInput = document.getElementById('category');
                const nameInput = document.getElementById('videoName');

                if (!fileInput.files[0]) {
                    showError('Please select a video file');
                    return;
                }

                files = [fileInput.files[0]];
                category = categoryInput.value;
                formData.append('file', files[0]);
                formData.append('name_0', nameInput.value || files[0].name);
            } else {
                const fileInput = document.getElementById('bulkVideoFiles');
                const categoryInput = document.getElementById('bulkCategory');

                if (fileInput.files.length === 0) {
                    showError('Please select video files');
                    return;
                }

                files = Array.from(fileInput.files);
                category = categoryInput.value;

                files.forEach((file, index) => {
                    formData.append('file', file);
                    formData.append(`name_${index}`, file.name);
                });
            }

            formData.append('category', category);

            // Show progress UI
            showUploadProgress(files);

            // Create AbortController for cancellation
            uploadController = new AbortController();

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData,
                    signal: uploadController.signal,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();

                if (result.Success || result.SuccessfulUploads > 0) {
                    const message = result.Success
                        ? `All ${result.TotalFiles} files uploaded successfully!`
                        : `${result.SuccessfulUploads} of ${result.TotalFiles} files uploaded successfully!`;
                    showSuccess(message);

                    // Reset forms
                    if (mode === 'single') {
                        document.getElementById('singleUploadForm').reset();
                    } else {
                        document.getElementById('bulkUploadForm').reset();
                        document.getElementById('bulkFileList').style.display = 'none';
                    }

                    // Refresh data
                    loadCategories();
                    if (currentCategory === category) {
                        selectCategory(currentCategory);
                    }
                    updateUploadCategoryDropdown();
                } else {
                    showError(result.Message || 'Upload failed');
                }
            } catch (error) {
                console.error('Error uploading files:', error);

                if (error.name === 'AbortError') {
                    showError('Upload was cancelled');
                } else if (error.message.includes('Failed to fetch')) {
                    showError('Network error - please check your connection and try again');
                } else {
                    showError(`Upload failed: ${error.message}`);
                }
            } finally {
                hideUploadProgress();
                uploadController = null;
            }
        }

        // Progress UI functions
        function showUploadProgress(files) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressTitle = document.getElementById('progressTitle');
            const individualProgress = document.getElementById('individualProgress');

            progressTitle.textContent = `Uploading ${files.length} file${files.length > 1 ? 's' : ''}...`;
            progressDiv.style.display = 'block';

            // Create individual progress bars
            individualProgress.innerHTML = '';
            files.forEach((file, index) => {
                const fileSizeMB = (file.size / 1024 / 1024).toFixed(1);
                const progressItem = document.createElement('div');
                progressItem.className = 'file-progress-item';
                progressItem.id = `file-progress-${index}`;
                progressItem.innerHTML = `
                    <span class='file-progress-name'>${file.name} (${fileSizeMB} MB)</span>
                    <div class='file-progress-bar'>
                        <div class='file-progress-fill' id='file-progress-fill-${index}'></div>
                    </div>
                    <span class='file-progress-status' id='file-progress-status-${index}'>Waiting...</span>
                `;
                individualProgress.appendChild(progressItem);
            });
        }

        function hideUploadProgress() {
            document.getElementById('uploadProgress').style.display = 'none';
        }

        function updateFileProgress(fileIndex, progress, status) {
            const fill = document.getElementById(`file-progress-fill-${fileIndex}`);
            const statusSpan = document.getElementById(`file-progress-status-${fileIndex}`);
            const item = document.getElementById(`file-progress-${fileIndex}`);

            if (fill) fill.style.width = `${progress}%`;
            if (statusSpan) statusSpan.textContent = status;

            if (status === 'Complete') {
                item.classList.add('upload-complete');
            } else if (status === 'Error') {
                item.classList.add('upload-error');
            }
        }

        function updateOverallProgress(progress) {
            const fill = document.getElementById('overallProgressFill');
            const text = document.getElementById('overallProgressText');

            if (fill) fill.style.width = `${progress}%`;
            if (text) text.textContent = `${Math.round(progress)}%`;
        }

        // Scheduling functions
        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules');
                schedules = await response.json();

                const grid = document.getElementById('schedulesList');
                if (schedules.length === 0) {
                    grid.innerHTML = '<p>No schedules created yet. Click "Create Schedule" to add one!</p>';
                    return;
                }

                grid.innerHTML = schedules.map(schedule => `
                    <div class='schedule-item'>
                        <h4>${schedule.Description}</h4>
                        <div class='schedule-meta'>
                            Category: ${schedule.CategoryName}<br>
                            Type: ${schedule.Type}<br>
                            Next Run: ${new Date(schedule.StartDate).toLocaleString()}<br>
                            Status: ${schedule.IsActive ? '✅ Active' : '❌ Inactive'}
                        </div>
                        <div class='schedule-actions'>
                            <button class='btn btn-secondary' onclick='editSchedule("${schedule.Id}")'>Edit</button>
                            <button class='btn btn-secondary' onclick='deleteSchedule("${schedule.Id}")'>Delete</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading schedules:', error);
                document.getElementById('schedulesList').innerHTML = '<div class="error">Failed to load schedules</div>';
            }
        }

        function updateUploadCategoryDropdown() {
            const categoryOptions = categories.map(cat =>
                `<option value="${cat.Name}">`
            ).join('');

            document.getElementById('categoryList').innerHTML = categoryOptions;
        }

        function showScheduleModal() {
            // Load categories for the dropdown
            fetch('/api/categories')
                .then(response => response.json())
                .then(categories => {
                    const select = document.getElementById('scheduleCategory');
                    select.innerHTML = '<option value="">Select Category</option>' +
                        categories.map(cat => `<option value="${cat.Name}">${cat.Name}</option>`).join('');
                });

            document.getElementById('scheduleModal').style.display = 'block';
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').style.display = 'none';
            document.getElementById('scheduleForm').reset();
        }

        function toggleDateFields() {
            const type = document.getElementById('scheduleType').value;
            const endDateGroup = document.getElementById('endDateGroup');
            endDateGroup.style.display = type === 'OneTime' ? 'none' : 'block';
        }

        // Schedule form handler
        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                CategoryName: document.getElementById('scheduleCategory').value,
                Type: document.getElementById('scheduleType').value,
                StartDate: document.getElementById('startDate').value,
                EndDate: document.getElementById('endDate').value || null,
                Description: document.getElementById('scheduleDescription').value,
                IsActive: true
            };

            try {
                const response = await fetch('/api/schedules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showSuccess('Schedule created successfully!');
                    closeScheduleModal();
                    loadSchedules();
                } else {
                    showError('Failed to create schedule');
                }
            } catch (error) {
                console.error('Error creating schedule:', error);
                showError('Failed to create schedule');
            }
        });

        async function deleteSchedule(scheduleId) {
            if (!confirm('Are you sure you want to delete this schedule?')) return;

            try {
                const response = await fetch(`/api/schedules/${scheduleId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showSuccess('Schedule deleted successfully!');
                    loadSchedules();
                } else {
                    showError('Failed to delete schedule');
                }
            } catch (error) {
                console.error('Error deleting schedule:', error);
                showError('Failed to delete schedule');
            }
        }

        // Video preview functionality
        function previewVideo(videoPath) {
            // Create a modal for video preview
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;

            const videoContainer = document.createElement('div');
            videoContainer.style.cssText = `
                background: #000;
                border-radius: 8px;
                padding: 20px;
                max-width: 90vw;
                max-height: 90vh;
                position: relative;
            `;

            const closeButton = document.createElement('button');
            closeButton.textContent = '✕';
            closeButton.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.7);
                color: white;
                border: none;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                cursor: pointer;
                font-size: 16px;
            `;

            const video = document.createElement('video');
            video.src = videoPath;
            video.controls = true;
            video.style.cssText = `
                max-width: 100%;
                max-height: 70vh;
                border-radius: 4px;
            `;

            closeButton.onclick = () => {
                video.pause();
                document.body.removeChild(modal);
            };

            modal.onclick = (e) => {
                if (e.target === modal) {
                    video.pause();
                    document.body.removeChild(modal);
                }
            };

            videoContainer.appendChild(closeButton);
            videoContainer.appendChild(video);
            modal.appendChild(videoContainer);
            document.body.appendChild(modal);

            // Focus the video for keyboard controls
            video.focus();
        }

        // Format duration from TimeSpan
        function formatDuration(duration) {
            if (!duration) return '';

            const totalSeconds = Math.floor(duration / 10000000); // Convert ticks to seconds
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Utility functions
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.container').firstChild);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.container').firstChild);
            setTimeout(() => successDiv.remove(), 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStatus();
            loadCategories();
            loadSchedules();

            // Refresh data every 30 seconds
            setInterval(() => {
                loadStatus();
                loadCategories();
            }, 30000);
        });
    </script>
</body>
</html>